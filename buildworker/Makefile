include ../common.mk

buildall:

# Build "buildall" target that builds the docker-compose directories
$(foreach f,$(HFS),$(eval $(call add_dep,buildall,build-$(f))))

# Build "deployall" target that brings up all images that are compatible with our arch
BUILD_HFS=$(call BUILD_FILT,$(HFS))
$(foreach f,$(BUILD_HFS),$(eval $(call add_dep,deployall,deploy-$(f))))

# Build "downall" target that takes down all workers that are compatible with our arch
$(foreach f,$(BUILD_HFS),$(eval $(call add_dep,downall,down-$(f))))

# Here's where we take our templates and build docker-compose files out of them
define build_dockercompose
build-$(1): build/$(1)/docker-compose.yml build/$(1)/worker/Dockerfile build/$(1)/tabularasa/Dockerfile

build/$(1)/tabularasa/Dockerfile: Dockerfile.template start_worker.sh $(shell ../dockerdeps ../workerbase/$(1).Dockerfile)
	@echo $(1)/tabularasa
	@# Build tabularasa directory
	@mkdir -p "build/$(1)/tabularasa"
	@echo "## This file was autogenerated" > "build/$(1)/tabularasa/Dockerfile"
	@echo "# Do not edit directly; edit the template files" >> "build/$(1)/tabularasa/Dockerfile"
	@echo "FROM $(call tabularasa_tag_name,$(1))" >> "build/$(1)/tabularasa/Dockerfile"
	@cat Dockerfile.template >> "build/$(1)/tabularasa/Dockerfile"
	@cp ./start_worker.sh "build/$(1)/tabularasa/start_worker.sh"

build/$(1)/worker/Dockerfile: Dockerfile.template start_worker.sh $(shell ../dockerdeps ../workerbase/$(1).Dockerfile)
	@echo $(1)/worker
	@# Build worker directory
	@mkdir -p "build/$(1)/worker"
	@echo "## This file was autogenerated" > "build/$(1)/worker/Dockerfile"
	@echo "# Do not edit directly; edit the template files" >> "build/$(1)/worker/Dockerfile"
	@echo "FROM $(call worker_tag_name,$(1))" >> "build/$(1)/worker/Dockerfile"
	@cat Dockerfile.template >> "build/$(1)/worker/Dockerfile"
	@cp ./start_worker.sh "build/$(1)/worker/start_worker.sh"

build/$(1)/docker-compose.yml: docker-compose.template.yml override.env secret.env $(shell ../dockerdeps ../workerbase/$(1).Dockerfile)
	@echo $(1)
	@mkdir -p "build/$(1)"
	@echo "## Autogenerated from secret.env and override.env" > "build/$(1)/.env"
	@cat secret.env >> "build/$(1)/.env"
	@[ ! -f override.env ] || cat override.env >> "build/$(1)/.env"
	@sed -e "s/{service_name}/$(1)/g" docker-compose.template.yml > "build/$(1)/docker-compose.yml"
	@sed -i.bak -e "s&{home}&$(HOME)&g" "build/$(1)/docker-compose.yml"
	@case $(call worker_tag_name,$(1)) in \
		*x86) sed -i.bak -e "s/{linux32}/linux32/g" "build/$(1)/docker-compose.yml";; \
		*)    sed -i.bak -e "s/{linux32}/       /g" "build/$(1)/docker-compose.yml";; \
	esac
	@rm -f build/$(1)/*.bak


pull-$(1):
	docker pull $(call worker_tag_name,$(1))

deploy-$(1): build-$(1) ipv6_internal
	@# chmod /var/run/docker.sock so that our docker guests can create images too
	@sudo chmod o+rw /var/run/docker.sock
	@# Build our new worker, take down the old one and bring the new one up
	@cd build/$(1); \
	docker-compose build --pull; \
	COMPOSE_HTTP_TIMEOUT=300 docker-compose up -d

down-$(1):
	@if [ -d build/$(1) ]; then \
		cd build/$(1); \
		docker-compose down --remove-orphans; \
	fi
endef

# Makefile target to make our internal ipv6 network
ipv6_internal:
	@if [ -z "$(shell docker network ls | grep ipv6_internal)" ]; then \
		docker network create --internal --ipv6 --subnet "fdeb:feed:face::/48" ipv6_internal; \
	fi

# Call build_dockercompose on each and every Dockerfile
$(foreach f,$(HFS),$(eval $(call build_dockercompose,$(f))))


clean:
	rm -rf build
